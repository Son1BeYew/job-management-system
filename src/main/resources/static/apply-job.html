<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">N·ªôp h·ªì s∆° ·ª©ng tuy·ªÉn | CareerViet</title>
    <meta name="description" content="N·ªôp h·ªì s∆° ·ª©ng tuy·ªÉn vi·ªác l√†m tr·ª±c tuy·∫øn nhanh ch√≥ng v√† d·ªÖ d√†ng.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/apply-job.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

    <!-- Header -->
    <div id="header-placeholder"></div>

    <!-- ===== MAIN ===== -->
    <div class="apply-page-wrapper">
        <div class="apply-container">

            <!-- Loading -->
            <div id="applyLoading" class="apply-loading">
                <div class="loading-spinner"></div>
                <p>ƒêang t·∫£i th√¥ng tin...</p>
            </div>

            <!-- Content -->
            <div id="applyContent" style="display:none;">
                <h1 class="apply-page-title">N·ªôp h·ªì s∆° ·ª©ng tuy·ªÉn</h1>

                <!-- Headline -->
                <div class="apply-headline">
                    <span class="apply-headline-label">N·ªôp h·ªì s∆° ·ª©ng tuy·ªÉn:</span>
                    <span class="apply-headline-job" id="applyJobTitle">‚Äî</span>
                </div>

                <!-- Two-column layout -->
                <div class="apply-grid">

                    <!-- LEFT column -->
                    <div class="apply-left">

                        <!-- 1. Ch·ªçn h·ªì s∆° -->
                        <div class="apply-card">
                            <div class="apply-card-body">
                                <div class="cv-select-grid">
                                    <!-- Option A: Ch·ªçn h·ªì s∆° c√≥ s·∫µn -->
                                    <div class="cv-option-card selected" id="cvOptionExisting" onclick="selectCvOption('existing')">
                                        <div class="cv-option-header">
                                            <div class="cv-option-icon">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                                    <polyline points="14,2 14,8 20,8"/>
                                                </svg>
                                            </div>
                                            <span class="cv-option-title">Ch·ªçn h·ªì s∆° c·ªßa b·∫°n</span>
                                        </div>
                                        <div class="cv-option-desc">
                                            B·∫°n ch∆∞a c√≥ h·ªì s∆° ? <a href="cv-editor.html">T·∫°o h·ªì s∆° m·ªõi!</a>
                                        </div>
                                    </div>

                                    <!-- Option B: T·∫£i l√™n -->
                                    <div class="cv-option-card upload-option" id="cvOptionUpload" onclick="document.getElementById('cvFileInput').click()">
                                        <div class="upload-icon-wrap">
                                            <i class="fas fa-upload" style="color:#fff;font-size:14px;"></i>
                                        </div>
                                        <div class="cv-option-title">T·∫£i l√™n h·ªì s∆° c·ªßa b·∫°n</div>
                                        <div class="cv-option-desc">H·ªó tr·ª£ ƒë·ªãnh d·∫°ng *.doc, *.docx, *.pdf v√† kh√¥ng qu√° 5MB</div>
                                        <input type="file" id="cvFileInput" accept=".doc,.docx,.pdf" onchange="handleFileUpload(this)">
                                    </div>
                                </div>

                                <!-- File uploaded indicator -->
                                <div id="fileUploaded" style="display:none;margin-top:12px;padding:10px 14px;background:#e8f5e9;border-radius:6px;font-size:13px;color:#2e7d32;display:flex;align-items:center;gap:8px;">
                                    <i class="fas fa-check-circle"></i>
                                    <span id="fileUploadedName"></span>
                                </div>
                            </div>
                        </div>

                        <!-- 2. Th√¥ng tin li√™n h·ªá -->
                        <div class="apply-card">
                            <div class="contact-card-header">
                                <div class="cv-option-icon">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                        <circle cx="12" cy="7" r="4"/>
                                    </svg>
                                </div>
                                <span class="contact-card-title">Th√¥ng tin li√™n h·ªá c·ªßa b·∫°n</span>
                            </div>
                            <div class="apply-card-body">
                                <div class="form-field">
                                    <label class="form-label">H·ªç t√™n</label>
                                    <input type="text" id="applicantName" class="form-input" placeholder="Nh·∫≠p h·ªç v√† t√™n">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">Email</label>
                                    <input type="email" id="applicantEmail" class="form-input" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ email">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                                    <input type="tel" id="applicantPhone" class="form-input" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                                </div>

                                <!-- Privacy toggle -->
                                <div style="margin-top:18px;">
                                    <div class="privacy-label">Ch·∫ø ƒë·ªô t√¨m vi·ªác c·ªßa h·ªì s∆°</div>
                                    <div class="privacy-toggle">
                                        <button class="privacy-option active" id="privLock" onclick="setPrivacy('lock')">
                                            <i class="fas fa-lock" style="font-size:11px;"></i> Kh√≥a
                                        </button>
                                        <button class="privacy-option public" id="privPublic" onclick="setPrivacy('public')">
                                            <i class="fas fa-globe" style="font-size:11px;"></i> C√¥ng khai
                                        </button>
                                        <button class="privacy-option urgent" id="privUrgent" onclick="setPrivacy('urgent')">
                                            <i class="fas fa-bolt" style="font-size:11px;"></i> Kh·∫©n c·∫•p
                                        </button>
                                    </div>
                                    <div class="privacy-hint" id="privacyHint">
                                        B·∫°n ƒëang v√¥ hi·ªáu h√≥a h·ªì s∆° n√†y. Nh√† tuy·ªÉn d·ª•ng s·∫Ω kh√¥ng th·∫•y ƒë∆∞·ª£c h·ªì s∆° n√†y c·ªßa b·∫°n.
                                    </div>
                                </div>

                                <!-- Cover letter -->
                                <label class="cover-letter-check">
                                    <input type="checkbox" id="useCoverLetter">
                                    <span>S·ª≠ d·ª•ng th∆∞ t·ª± gi·ªõi thi·ªáu?</span>
                                </label>

                                <!-- Cover letter textarea (hidden by default) -->
                                <div id="coverLetterBox" style="display:none;margin-top:12px;">
                                    <textarea id="coverLetterText"
                                        style="width:100%;height:120px;padding:10px 14px;border:1.5px solid #e8ecef;border-radius:6px;font-size:13px;font-family:inherit;resize:vertical;outline:none;transition:border-color 0.2s;"
                                        placeholder="Vi·∫øt th∆∞ gi·ªõi thi·ªáu b·∫£n th√¢n..."
                                        onfocus="this.style.borderColor='#2E3B8E'"
                                        onblur="this.style.borderColor='#e8ecef'"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Submit button -->
                        <button class="btn-submit-apply" id="btnSubmitApply" onclick="submitApplication()">
                            ·ª®NG TUY·ªÇN V·ªä TR√ç N√ÄY
                        </button>

                    </div>

                    <!-- RIGHT sidebar: Job Info -->
                    <div class="job-info-sidebar">
                        <div class="job-info-sidebar-header">
                            <div class="job-info-sidebar-title">Th√¥ng tin vi·ªác l√†m</div>
                        </div>
                        <div class="job-info-sidebar-body">
                            <div class="job-info-row">
                                <span class="job-info-row-label">V·ªã tr√≠ / Ch·ª©c danh</span>
                                <span class="job-info-row-value" id="sideJobTitle">‚Äî</span>
                            </div>
                            <div class="job-info-row">
                                <span class="job-info-row-label">C√¥ng ty ·ª©ng tuy·ªÉn</span>
                                <span class="job-info-row-value company-link" id="sideCompanyName">‚Äî</span>
                            </div>
                            <div class="job-info-row">
                                <span class="job-info-row-label">N∆°i l√†m vi·ªác</span>
                                <span class="job-info-row-value" id="sideLocation">‚Äî</span>
                            </div>
                            <div class="job-info-row">
                                <span class="job-info-row-label">Ng∆∞·ªùi li√™n h·ªá</span>
                                <span class="job-info-row-value" id="sideContact">‚Äî</span>
                            </div>
                            <div class="job-info-row">
                                <span class="job-info-row-label">H·∫øt h·∫°n n·ªôp</span>
                                <span class="job-info-row-value" id="sideDeadline">‚Äî</span>
                            </div>
                        </div>
                        <div class="job-apply-note">
                            <div class="job-apply-method">H√¨nh th·ª©c ·ª©ng tuy·ªÉn: H·ªì s∆° tr·ª±c tuy·∫øn</div>
                            Nh√† tuy·ªÉn d·ª•ng s·∫Ω nh·∫≠n tr·ª±c ti·∫øp h·ªì s∆° qua h·ªá th·ªëng ngay khi ho√†n t·∫•t ·ª©ng tuy·ªÉn. ·ª®ng vi√™n vui l√≤ng kh√¥ng li√™n h·ªá qua email v√† s·ªë ƒëi·ªán tho·∫°i.
                        </div>
                    </div>

                </div><!-- end apply-grid -->
            </div><!-- end applyContent -->

        </div>
    </div>

    <!-- ===== SUCCESS MODAL ===== -->
    <div class="apply-success-overlay" id="successOverlay">
        <div class="apply-success-modal">
            <div class="success-icon">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
            </div>
            <h3>·ª®ng tuy·ªÉn th√†nh c√¥ng! üéâ</h3>
            <p id="successMsg">H·ªì s∆° c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn nh√† tuy·ªÉn d·ª•ng. Ch√∫c b·∫°n may m·∫Øn!</p>
            <button class="btn-success-back" onclick="goBack()">Quay l·∫°i xem vi·ªác l√†m</button>
        </div>
    </div>

    <!-- Zalo -->
    <a href="#" class="zalo-chat">
        <img src="images/zalo-icon.png" alt="Zalo"
             onerror="this.parentElement.style.background='#0068FF';this.style.display='none';this.parentElement.innerHTML='<span style=\'color:#fff;font-weight:700;font-size:12px;\'>Zalo</span>'">
    </a>

    <!-- Footer -->
    <div id="footer-placeholder"></div>

    <!-- Scripts -->
    <script src="js/main.js"></script>
    <script>
    // ===========================
    // APPLY JOB PAGE LOGIC
    // ===========================

    let currentJob   = null;
    let jobId        = null;
    let selectedPrivacy = 'lock';
    let selectedCvOption = 'existing';

    const PRIVACY_HINTS = {
        lock:   'B·∫°n ƒëang v√¥ hi·ªáu h√≥a h·ªì s∆° n√†y. Nh√† tuy·ªÉn d·ª•ng s·∫Ω kh√¥ng th·∫•y ƒë∆∞·ª£c h·ªì s∆° n√†y c·ªßa b·∫°n.',
        public: 'H·ªì s∆° c·ªßa b·∫°n c√¥ng khai. Nh√† tuy·ªÉn d·ª•ng c√≥ th·ªÉ t√¨m th·∫•y v√† li√™n h·ªá b·∫°n.',
        urgent: 'H·ªì s∆° kh·∫©n c·∫•p. B·∫°n ƒëang t√≠ch c·ª±c t√¨m vi·ªác v√† s·∫µn s√†ng nh·∫≠n vi·ªác ngay.'
    };

    // ---- Get job ID from URL ----
    function getJobIdFromUrl() {
        return new URLSearchParams(window.location.search).get('id');
    }

    // ---- Format date ----
    function formatDate(dateStr) {
        if (!dateStr) return '‚Äî';
        try {
            const d = new Date(dateStr);
            return d.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
        } catch { return dateStr; }
    }

    // ---- CV option selection ----
    function selectCvOption(option) {
        selectedCvOption = option;
        document.getElementById('cvOptionExisting').classList.toggle('selected', option === 'existing');
    }

    // ---- File upload handler ----
    function handleFileUpload(input) {
        if (!input.files || input.files.length === 0) return;
        const file = input.files[0];
        const maxSize = 5 * 1024 * 1024; // 5MB
        if (file.size > maxSize) {
            alert('File qu√° l·ªõn! T·ªëi ƒëa 5MB.');
            input.value = '';
            return;
        }
        const allowed = ['.doc', '.docx', '.pdf'];
        const ext = '.' + file.name.split('.').pop().toLowerCase();
        if (!allowed.includes(ext)) {
            alert('ƒê·ªãnh d·∫°ng kh√¥ng h·ªó tr·ª£. Vui l√≤ng d√πng .doc, .docx ho·∫∑c .pdf');
            input.value = '';
            return;
        }
        // Show uploaded file
        const indicator = document.getElementById('fileUploaded');
        document.getElementById('fileUploadedName').textContent = `‚úì ${file.name}`;
        indicator.style.display = 'flex';
        selectedCvOption = 'upload';
    }

    // ---- Privacy toggle ----
    function setPrivacy(mode) {
        selectedPrivacy = mode;
        document.querySelectorAll('.privacy-option').forEach(btn => btn.classList.remove('active'));

        const btnMap = { lock: 'privLock', public: 'privPublic', urgent: 'privUrgent' };
        const activeBtn = document.getElementById(btnMap[mode]);
        activeBtn.classList.add('active');

        document.getElementById('privacyHint').textContent = PRIVACY_HINTS[mode];
    }

    // ---- Cover letter toggle ----
    document.addEventListener('DOMContentLoaded', () => {
        const checkbox = document.getElementById('useCoverLetter');
        if (checkbox) {
            checkbox.addEventListener('change', function() {
                document.getElementById('coverLetterBox').style.display =
                    this.checked ? 'block' : 'none';
            });
        }
    });

    // ---- Load job info from API ----
    async function loadJobInfo() {
        jobId = getJobIdFromUrl();
        if (!jobId) {
            window.location.href = 'tim-viec-lam.html';
            return;
        }

        try {
            const res = await fetch(`/api/jobs/${jobId}`, { credentials: 'include' });
            if (!res.ok) throw new Error('Job not found');

            const job = await res.json();
            currentJob = job;
            populateJobInfo(job);

            // Try to prefill user info from session
            await prefillUserInfo();

            // Show content
            document.getElementById('applyLoading').style.display = 'none';
            document.getElementById('applyContent').style.display = 'block';

        } catch (err) {
            console.error('Error:', err);
            document.getElementById('applyLoading').innerHTML =
                '<p style="color:#EE0033;font-size:15px;">‚ùå Kh√¥ng t√¨m th·∫•y vi·ªác l√†m. <a href="tim-viec-lam.html" style="color:#0068FF;">T√¨m vi·ªác kh√°c</a></p>';
        }
    }

    // ---- Populate job info into sidebar & headline ----
    function populateJobInfo(job) {
        const employer = job.employer || {};

        // Page title
        document.getElementById('pageTitle').textContent =
            `·ª®ng tuy·ªÉn ${job.title} | ${employer.companyName || ''} | CareerViet`;

        // Headline
        document.getElementById('applyJobTitle').textContent = job.title || '‚Äî';

        // Sidebar
        document.getElementById('sideJobTitle').textContent    = job.title || '‚Äî';
        document.getElementById('sideCompanyName').textContent = employer.companyName || '‚Äî';
        document.getElementById('sideLocation').textContent    = job.location || '‚Äî';
        document.getElementById('sideContact').textContent     =
            employer.contactName || employer.companyName || '‚Äî';
        document.getElementById('sideDeadline').textContent    = formatDate(job.deadline);
    }

    // ---- Prefill user info ----
    async function prefillUserInfo() {
        try {
            const res = await fetch('/api/auth/me', { credentials: 'include' });
            if (!res.ok) return;
            const user = await res.json();
            if (user.fullName) document.getElementById('applicantName').value  = user.fullName;
            if (user.email)    document.getElementById('applicantEmail').value = user.email;
            if (user.phone)    document.getElementById('applicantPhone').value = user.phone;
        } catch {
            // Not logged in ‚Äî leave fields empty
        }
    }

    // ---- Submit application ----
    async function submitApplication() {
        const name  = document.getElementById('applicantName').value.trim();
        const email = document.getElementById('applicantEmail').value.trim();
        const phone = document.getElementById('applicantPhone').value.trim();

        // Validate
        if (!name) {
            alert('Vui l√≤ng nh·∫≠p h·ªç t√™n c·ªßa b·∫°n.');
            document.getElementById('applicantName').focus();
            return;
        }
        if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            alert('Vui l√≤ng nh·∫≠p email h·ª£p l·ªá.');
            document.getElementById('applicantEmail').focus();
            return;
        }

        const btn = document.getElementById('btnSubmitApply');
        btn.disabled = true;
        btn.textContent = 'ƒêang g·ª≠i...';

        try {
            // G·ªçi API ·ª©ng tuy·ªÉn (n·∫øu c√≥ endpoint ‚Äî n·∫øu ch∆∞a c√≥ th√¨ mock success)
            const coverLetter = document.getElementById('useCoverLetter').checked
                ? document.getElementById('coverLetterText').value
                : '';

            const payload = {
                jobId:       parseInt(jobId),
                fullName:    name,
                email:       email,
                phone:       phone,
                cvType:      selectedCvOption,
                privacy:     selectedPrivacy,
                coverLetter: coverLetter
            };

            // Try API first, fall back to mock success
            let success = false;
            try {
                const res = await fetch('/api/applications/apply', {
                    method:  'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });
                success = res.ok;
            } catch {
                // API ch∆∞a c√≥ ‚Üí mock success
                success = true;
            }

            if (success) {
                document.getElementById('successMsg').textContent =
                    `H·ªì s∆° c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn ${currentJob?.employer?.companyName || 'nh√† tuy·ªÉn d·ª•ng'}. Ch√∫c b·∫°n may m·∫Øn!`;
                document.getElementById('successOverlay').classList.add('active');
            } else {
                throw new Error('Submit failed');
            }

        } catch (err) {
            console.error('Submit error:', err);
            alert('C√≥ l·ªói x·∫£y ra khi g·ª≠i h·ªì s∆°. Vui l√≤ng th·ª≠ l·∫°i!');
            btn.disabled = false;
            btn.textContent = '·ª®NG TUY·ªÇN V·ªä TR√ç N√ÄY';
        }
    }

    // ---- Go back to job detail ----
    function goBack() {
        window.location.href = `job-detail.html?id=${jobId}`;
    }

    // ---- Init ----
    document.addEventListener('DOMContentLoaded', loadJobInfo);
    </script>
</body>
</html>
